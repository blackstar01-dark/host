<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Figuras - Tienda</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Registro de Figuras</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Formulario -->
      <div class="bg-white p-6 rounded-2xl shadow-sm">
        <form id="figuraForm" class="space-y-4" autocomplete="off">
          <div>
            <label for="codigo" class="block text-sm font-medium text-gray-700">Código de Figura (opcional)</label>
            <input id="codigo" name="codigo" type="number" placeholder="Ej. 101" class="mt-1 block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200"/>
          </div>

          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre de la Figura</label>
            <input id="nombre" name="Nombre" type="text" required class="mt-1 block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200"/>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
              <input id="categoria" name="Categoria" type="text" placeholder="Ej. Anime, Marvel, Artesanal" class="mt-1 block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200"/>
            </div>
            <div>
              <label for="precio" class="block text-sm font-medium text-gray-700">Precio</label>
              <input id="precio" name="Precio" type="number" step="0.01" class="mt-1 block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200"/>
            </div>
          </div>

          <div>
            <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
            <textarea id="descripcion" name="Descripcion" rows="3" class="mt-1 block w-full rounded-xl border border-gray-200 bg-gray-50 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-200"></textarea>
          </div>

          <div class="flex gap-3">
            <button id="btnSave" type="submit" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-400 to-purple-500 text-white font-semibold shadow-sm hover:from-purple-500 hover:to-purple-600 transition">Guardar</button>
            <button id="btnRefresh" type="button" class="py-3 px-4 rounded-xl bg-white border border-gray-200 text-gray-700 shadow-sm hover:bg-gray-50" title="Actualizar lista">Actualizar</button>
          </div>

          <p id="formMsg" class="text-sm text-gray-600"></p>
        </form>
      </div>

      <!-- Tabla de datos -->
      <div class="bg-white p-4 rounded-2xl shadow-sm overflow-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium text-gray-800">Figuras registradas</h2>
          <div class="text-sm text-gray-500">Actualizado: <span id="lastUpdated">—</span></div>
        </div>

        <div class="w-full overflow-x-auto">
          <table id="figurasTable" class="w-full text-sm text-left">
            <thead class="text-gray-600 uppercase text-xs">
              <tr>
                <th class="px-3 py-2">Código</th>
                <th class="px-3 py-2">Nombre</th>
                <th class="px-3 py-2">Categoría</th>
                <th class="px-3 py-2">Precio</th>
                <th class="px-3 py-2">Descripción</th>
                <th class="px-3 py-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="text-gray-700">
              <!-- Filas generadas por JS -->
            </tbody>
          </table>
        </div>

        <p id="tableMsg" class="mt-3 text-sm text-gray-600"></p>
      </div>
    </div>
  </div>

<script>
// Elementos del DOM
const form = document.getElementById('figuraForm');
const formMsg = document.getElementById('formMsg');
const tableMsg = document.getElementById('tableMsg');
const tableBody = document.getElementById('tableBody');
const lastUpdated = document.getElementById('lastUpdated');
const btnRefresh = document.getElementById('btnRefresh');

async function fetchList() {
  tableMsg.textContent = 'Cargando...';
  try {
    const res = await fetch('guardar_figura.php?action=list', { cache: 'no-store' });
    if (!res.ok) throw new Error('No fue posible obtener la lista (' + res.status + ')');
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Respuesta inválida del servidor.');
    renderTable(data.data || []);
    tableMsg.textContent = '';
    lastUpdated.textContent = new Date().toLocaleString();
  } catch (err) {
    console.error(err);
    tableMsg.textContent = 'Error cargando lista: ' + err.message;
    tableBody.innerHTML = '';
    lastUpdated.textContent = '—';
  }
}

function renderTable(items) {
  if (!Array.isArray(items) || items.length === 0) {
    tableBody.innerHTML = '<tr><td class="px-3 py-2" colspan="6">No hay figuras registradas.</td></tr>';
    return;
  }

  tableBody.innerHTML = items.map(item => {
    const codigo = item.codigo ?? '';
    const nombre = escapeHtml(item.Nombre || '');
    const categoria = escapeHtml(item.Categoria || '');
    const precio = (item.Precio) ? Number(item.Precio).toLocaleString() : '';
    const descripcion = escapeHtml(item.Descripcion || '');

    return `<tr class="border-t">
      <td class="px-3 py-2 align-top">${codigo}</td>
      <td class="px-3 py-2 align-top">${nombre}</td>
      <td class="px-3 py-2 align-top">${categoria}</td>
      <td class="px-3 py-2 align-top">${precio}</td>
      <td class="px-3 py-2 align-top">${descripcion}</td>
      <td class="px-3 py-2 align-top">
        <button data-id="${codigo}" class="btnView text-xs px-2 py-1 rounded bg-gray-100 border">Ver</button>
      </td>
    </tr>`;
  }).join('');
}

function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMsg.textContent = 'Guardando...';
  const btn = document.getElementById('btnSave');
  btn.disabled = true;

  const payload = {
    codigo: document.getElementById('codigo').value,
    Nombre: document.getElementById('nombre').value,
    Categoria: document.getElementById('categoria').value,
    Precio: document.getElementById('precio').value,
    Descripcion: document.getElementById('descripcion').value
  };

  try {
    const res = await fetch('guardar_figura.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'Error al guardar.');
    formMsg.textContent = 'Figura guardada correctamente. ID: ' + (data.last_insert_id || 'N/A');
    form.reset();
    await fetchList();
  } catch (err) {
    console.error(err);
    formMsg.textContent = 'Error: ' + err.message;
  } finally {
    btn.disabled = false;
  }
});

btnRefresh.addEventListener('click', fetchList);

tableBody.addEventListener('click', (e) => {
  const btn = e.target.closest('.btnView');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  if (!id) return alert('Código no disponible');
  alert('Ver detalles de la figura con Código: ' + id + '\\n(implementa detalle en backend si lo deseas)');
});

// Cargar lista al inicio
fetchList();
</script>
</body>
</html>
